{% extends "base.html" %}
{% block title %}Carbon Cruncher - Dashboard{% endblock %}

{% block content %}
<style>

    .dashboard {
        display: grid;
        grid-template-columns: 1fr 2fr;
        grid-template-rows: auto auto;
        gap: 20px;
    }

    .card {
        padding: 20px;
        border-radius: 12px;
        background-color: #f4f4f4;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #total-emissions {
        font-size: 2.5em;
        font-weight: bold;
        color: #000000;
    }

    #dayDetail {
        margin-top: 10px;
        font-size: 1.2em;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<h1 class="text-center" style="padding-top: 50px; font-size: 50px">Your dashboard</h1>
<h3 class="text-center" style="padding-top: 20px; font-size: 20px">Look at your profile and past logs!</h3>
<h2 class="text-center" style="padding-top:20px; font-size: 30px"> Profile </h2>
<div style="padding-top: 20px; width: 50%;" class="container text-center">
    <h3>Username: {{current_user.username}}
        {% if current_user.is_admin %}
         [ADMIN]
        {% endif %}
    </h3>
    <h3>Real name: {{current_user.first_name}} {{current_user.last_name}}</h3>
    <h3>Email address: {{current_user.email}}</h3>
    <h3><img src="{{url_for('static', filename='coin.png')}}" width="50px">Ecopoints: {{current_user.ecopoints}}</h3>
</div>

<h2 class="text-center" style="padding-top:20px; font-size: 30px"> Carbon Logs </h2>

<div style="padding-top: 20px; width:50%" class="container text-center">
    <label for="yearSelect">Year:</label>
    <input type="number" id="yearSelect" min="2000" max="2100" value="2025">

    <label for="weekSelect">Week:</label>
    <input type="number" id="weekSelect" min="1" max="53" value="1">
    <br><br>
    <button onclick="goToWeek()" class="navicon-light" style="background-color: #8ad87d;width: 40%; border-radius: 25px 25px 25px 25px; margin: 0;  border: 4px; border-style: solid; border-color: #54834c; display: inline-block;">View</button>
</div>

<div class="dashboard container" style="width:85%;">

    <div class="card" style="grid-column: 1; grid-row: 1;">
        <div>Total Emissions</div>
        <div id="total-emissions"><span id="totalEmissionValue">0</span> kg COâ‚‚</div>
    </div>

    <div class="card" style="grid-column: 1; grid-row: 2;">
        <div><strong>Emission Breakdown</strong></div>
        <canvas id="emissionPieChart"></canvas>
    </div>

    <div class="card" style="grid-column: 2; grid-row: 1 / span 2;">
        <div><strong>Emission History</strong></div>
        <canvas id="emissionBarChart" height="200"></canvas>
    </div>
</div>

<script>
    function goToWeek() {
        const year = document.getElementById('yearSelect').value;
        const week = document.getElementById('weekSelect').value;

        if (year && week >= 1 && week <= 53) {
            window.location.href = `/dashboard/${year}/${week}`;
        } else {
            alert("Please enter a valid year and week number (1â€“53).");
        }
    }

    async function loadData() {
        const pathParts = window.location.pathname.split('/');
        const year = pathParts[2];
        const week = pathParts[3];

        document.getElementById("yearSelect").value = year;
        document.getElementById("weekSelect").value = week;

        const apiUrl = `/weekly_emissions/${year}/${week}`;
        const res = await fetch(apiUrl);
        const data = await res.json();


        const {labels, daily_emissions, breakdown_labels, breakdown_data} = data;

        const total = daily_emissions.reduce((sum, v) => sum + v, 0);
        document.getElementById("totalEmissionValue").innerText = total.toFixed(2);

        new Chart(document.getElementById('emissionPieChart').getContext('2d'), {
            type: 'pie',
            data: {
                labels: breakdown_labels,
                datasets: [{
                    data: breakdown_data,
                    backgroundColor: ['#4caf50', '#8bc34a', '#cddc39', '#ff9800']
                }]
            },
            options: {
                responsive: true,
                plugins: {legend: {position: 'bottom'}}
            }
        });

        new Chart(document.getElementById('emissionBarChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Daily Emission (kg COâ‚‚)',
                    data: daily_emissions,
                    backgroundColor: '#81c784'
                }]
            },
            options: {
                responsive: true,
                onClick: (evt, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const date = labels[index];
                        const value = daily_emissions[index];
                        document.getElementById("dayDetail").innerText = `ðŸ“… ${date} â†’ ${value} kg COâ‚‚`;
                    }
                },
                scales: {
                    y: {beginAtZero: true}
                }
            }
        });
    }

    loadData();
</script>
<div id="dayDetail" style="margin-top: 10px; font-size: 1.2em;"></div>


</body>
{% endblock %}